version: '3.8'
services:
  redis:
    labels:
      - "project=microservices-demo"
    image: redis:7-alpine
    container_name: redis-service
    ports:
      - "6379:6379"
    networks:
      - microservices-demo

  ad-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/adservice
      dockerfile: Dockerfile
    image: DOCKER_USER/ad-service:TAG
    container_name: ad-service
    ports:
      - "7007:7007"
    networks:
      - microservices-demo
    environment:
      - PORT=7007
      - DISABLE_PROFILER=1

  cart-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/cartservice
      dockerfile: Dockerfile
    image: DOCKER_USER/cart-service:TAG
    container_name: cart-service
    ports: 
      - "7006:7006"
    depends_on:
      - redis
    networks:
      - microservices-demo
    environment:
      - ASPNETCORE_URLS=http://*:7006
      - REDIS_ADDR=redis-service:6379
      - DISABLE_PROFILER=1

  product-catalog-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/productcatalogservice
      dockerfile: Dockerfile
    image: DOCKER_USER/product-catalog-service:TAG
    container_name: product-catalog-service
    ports:
      - "7002:7002"
    networks:
      - microservices-demo
    environment:
      - PORT=7002
      - DISABLE_PROFILER=1
  
  recommendation-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/recommendationservice
      dockerfile: Dockerfile
    image: DOCKER_USER/recommendation-service:TAG
    container_name: recommendation-service
    ports:
      - "7005:7005"
    networks:
      - microservices-demo
    environment:
      - PORT=7005
      - DISABLE_PROFILER=1
      - PRODUCT_CATALOG_SERVICE_ADDR=product-catalog-service:7002
    depends_on:
      - product-catalog-service
    
  shipping-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/shippingservice
      dockerfile: Dockerfile
    image: DOCKER_USER/shipping-service:TAG
    container_name: shipping-service
    ports:
      - "7003:7003"
    networks:
      - microservices-demo
    environment:
      - PORT=7003
      - DISABLE_PROFILER=1
  
  currency-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/currencyservice
      dockerfile: Dockerfile
    image: DOCKER_USER/currency-service:TAG
    container_name: currency-service
    ports:
      - "7000:7000"
    networks:
      - microservices-demo
    environment:
      - PORT=7000
      - DISABLE_PROFILER=1

  payment-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/paymentservice
      dockerfile: Dockerfile
    image: DOCKER_USER/payment-service:TAG
    container_name: payment-service
    ports:
      - "7001:7001"
    networks:
      - microservices-demo
    environment:
      - PORT=7001
      - DISABLE_PROFILER=1

  email-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/emailservice
      dockerfile: Dockerfile
    image: DOCKER_USER/email-service:TAG
    container_name: email-service
    ports:
      - "7004:7004"
    networks:
      - microservices-demo
    environment:
      - PORT=7004
      - DISABLE_PROFILER=1

  checkout-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/checkoutservice
      dockerfile: Dockerfile
    image: DOCKER_USER/checkout-service:TAG
    container_name: checkout-service
    ports:
      - "7008:7008"
    networks:
      - microservices-demo
    environment:
      - PORT=7008
      - DISABLE_PROFILER=1
      - CURRENCY_SERVICE_ADDR=currency-service:7000
      - PRODUCT_CATALOG_SERVICE_ADDR=product-catalog-service:7002
      - SHIPPING_SERVICE_ADDR=shipping-service:7003
      - EMAIL_SERVICE_ADDR=email-service:7004
      - CART_SERVICE_ADDR=cart-service:7006
      - PAYMENT_SERVICE_ADDR=payment-service:7001
    depends_on:
      - product-catalog-service
      - shipping-service
      - email-service
      - recommendation-service
      - cart-service
      - payment-service
  
  frontend-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
    image: DOCKER_USER/frontend:TAG
    container_name: frontend-service
    ports:
      - "7009:7009"
    networks:
      - microservices-demo
    environment:
      - PORT=7009
      - DISABLE_PROFILER=1
      - CURRENCY_SERVICE_ADDR=currency-service:7000
      - PRODUCT_CATALOG_SERVICE_ADDR=product-catalog-service:7002
      - SHIPPING_SERVICE_ADDR=shipping-service:7003
      - RECOMMENDATION_SERVICE_ADDR=recommendation-service:7005
      - CART_SERVICE_ADDR=cart-service:7006
      - AD_SERVICE_ADDR=ad-service:7007
      - CHECKOUT_SERVICE_ADDR=checkout-service:7008
      - SHOPPING_ASSISTANT_SERVICE_ADDR=localhost:9999
    depends_on:
      - currency-service
      - product-catalog-service
      - shipping-service
      - recommendation-service
      - cart-service
      - ad-service
      - checkout-service

networks:
  microservices-demo:
    driver: bridge