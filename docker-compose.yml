services:
  redis:
    labels:
      - "project=microservices-demo"
    image: redis:7-alpine
    container_name: redis-service
    ports:
      - "6379:6379"
    networks:
      - microservices-demo

  mysql:
    labels:
      - "project=microservices-demo"
    image: mysql:8.0
    container_name: mysql-service
    ports:
      - "3306:3306"
    networks:
      - microservices-demo
    environment:
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_DATABASE=productcatalog
      - MYSQL_USER=catalog_user
      - MYSQL_PASSWORD=catalog_password
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "catalog_user", "-pcatalog_password"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  flyway:
    labels:
      - "project=microservices-demo"
    build:
      context: ./db
      dockerfile: Dockerfile
    image: flyway-migration
    container_name: flyway-service
    command: -url=jdbc:mysql://mysql-service:3306/productcatalog -user=catalog_user -password=catalog_password -connectRetries=60 migrate
    networks:
      - microservices-demo
    depends_on:
      mysql:
        condition: service_healthy

  ad-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/ad-service
      dockerfile: Dockerfile
    image: ad-service
    container_name: ad-service
    ports:
      - "7007:7007"
      - "7107:7107"
    networks:
      - microservices-demo
    environment:
      - PORT=7007
      - HEALTH_PORT=7107
      - DISABLE_PROFILER=1

  cart-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/cartservice
      dockerfile: Dockerfile
    image: cart-service
    container_name: cart-service
    ports:
      - "7006:7006"
    depends_on:
      - redis
    networks:
      - microservices-demo
    environment:
      - ASPNETCORE_URLS=http://*:7006
      - REDIS_ADDR=redis-service:6379
      - DISABLE_PROFILER=1

  product-catalog-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/productcatalogservice
      dockerfile: Dockerfile
    image: product-catalog-service
    container_name: product-catalog-service
    ports:
      - "7002:7002"
    networks:
      - microservices-demo
    environment:
      - PORT=7002
      - DISABLE_PROFILER=1
      - MYSQL_HOST=mysql-service
      - MYSQL_PORT=3306
      - MYSQL_USER=catalog_user
      - MYSQL_PASSWORD=catalog_password
      - MYSQL_DATABASE=productcatalog
    depends_on:
      mysql:
        condition: service_healthy
      flyway:
        condition: service_completed_successfully

  recommendation-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/recommendationservice
      dockerfile: Dockerfile
    image: recommendation-service
    container_name: recommendation-service
    ports:
      - "7005:7005"
    networks:
      - microservices-demo
    environment:
      - PORT=7005
      - DISABLE_PROFILER=1
      - PRODUCT_CATALOG_SERVICE_ADDR=product-catalog-service:7002
    depends_on:
      - product-catalog-service

  shipping-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/shippingservice
      dockerfile: Dockerfile
    image: shipping-service
    container_name: shipping-service
    ports:
      - "7003:7003"
    networks:
      - microservices-demo
    environment:
      - PORT=7003
      - DISABLE_PROFILER=1

  currency-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/currencyservice
      dockerfile: Dockerfile
    image: currency-service
    container_name: currency-service
    ports:
      - "7000:7000"
    networks:
      - microservices-demo
    environment:
      - PORT=7000
      - DISABLE_PROFILER=1

  payment-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/paymentservice
      dockerfile: Dockerfile
    image: payment-service
    container_name: payment-service
    ports:
      - "7001:7001"
    networks:
      - microservices-demo
    environment:
      - PORT=7001
      - DISABLE_PROFILER=1

  email-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/emailservice
      dockerfile: Dockerfile
    image: email-service
    container_name: email-service
    ports:
      - "7004:7004"
    networks:
      - microservices-demo
    environment:
      - PORT=7004
      - DISABLE_PROFILER=1

  checkout-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/checkoutservice
      dockerfile: Dockerfile
    image: checkout-service
    container_name: checkout-service
    ports:
      - "7008:7008"
    networks:
      - microservices-demo
    environment:
      - PORT=7008
      - DISABLE_PROFILER=1
      - CURRENCY_SERVICE_ADDR=currency-service:7000
      - PRODUCT_CATALOG_SERVICE_ADDR=product-catalog-service:7002
      - SHIPPING_SERVICE_ADDR=shipping-service:7003
      - EMAIL_SERVICE_ADDR=email-service:7004
      - CART_SERVICE_ADDR=cart-service:7006
      - PAYMENT_SERVICE_ADDR=payment-service:7001
    depends_on:
      - product-catalog-service
      - shipping-service
      - email-service
      - recommendation-service
      - cart-service
      - payment-service

  frontend-service:
    labels:
      - "project=microservices-demo"
    build:
      context: ./src/frontend
      dockerfile: Dockerfile
    image: frontend
    container_name: frontend-service
    ports:
      - "7009:7009"
    networks:
      - microservices-demo
    environment:
      - PORT=7009
      - DISABLE_PROFILER=1
      - CURRENCY_SERVICE_ADDR=currency-service:7000
      - PRODUCT_CATALOG_SERVICE_ADDR=product-catalog-service:7002
      - SHIPPING_SERVICE_ADDR=shipping-service:7003
      - RECOMMENDATION_SERVICE_ADDR=recommendation-service:7005
      - CART_SERVICE_ADDR=cart-service:7006
      - AD_SERVICE_ADDR=ad-service:7007
      - CHECKOUT_SERVICE_ADDR=checkout-service:7008
      - SHOPPING_ASSISTANT_SERVICE_ADDR=localhost:9999
    depends_on:
      - currency-service
      - product-catalog-service
      - shipping-service
      - recommendation-service
      - cart-service
      - ad-service
      - checkout-service

volumes:
  mysql_data:


networks:
  microservices-demo:
    driver: bridge
